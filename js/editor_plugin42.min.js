/*
 *      editor_plugin.js
 *      
 *      Copyright 2014 Ed Hynan <edhynan@gmail.com>
 *      
 *      This program is free software; you can redistribute it and/or modify
 *      it under the terms of the GNU General Public License as published by
 *      the Free Software Foundation; specifically version 3 of the License.
 *      
 *      This program is distributed in the hope that it will be useful,
 *      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *      GNU General Public License for more details.
 *      
 *      You should have received a copy of the GNU General Public License
 *      along with this program; if not, write to the Free Software
 *      Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 *      MA 02110-1301, USA.
 */
function SWFPut_repl_nl(t){return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n/g,"<br />")}var SWFPut_video_utility_obj_def=function(){if(this.loadtime_serial=68719476735&this.unixtime(),void 0===this._fpo&&void 0!==SWFPut_putswf_video_inst)this.fpo=SWFPut_putswf_video_inst.fpo;else if(void 0===this.fpo){SWFPut_video_utility_obj_def.prototype._fpo={};var t=this._fpo;t.cmt="<!-- do not strip me -->",t.ent=t.cmt,t.enx=t.ent;var e=document.createElement("div");e.innerHTML=t.ent,t.enc=e.textContent||e.innerText||t.ent,t.rxs="(("+t.cmt+")|("+t.enx+")|("+t.enc+"))",t.rxx=".*"+t.rxs+".*",t.is=function(e,i){return e.match(RegExp(i?t.rxs:t.rxx))},this.fpo=this._fpo}this._bbone_mvc_opt="true"===swfput_mceplug_inf._bbone_mvc_opt};SWFPut_video_utility_obj_def.prototype={defprops:{url:"",cssurl:"",iimage:"",width:"240",height:"180",mobiwidth:"0",audio:"false",aspectautoadj:"false",displayaspect:"0",pixelaspect:"0",volume:"50",play:"false",hidebar:"true",disablebar:"false",iimgbg:"true",barheight:"36",quality:"high",allowfull:"true",allowxdom:"false",loop:"false",mtype:"application/x-shockwave-flash",playpath:"",altvideo:"",classid:"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000",codebase:"http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,115,0",align:"center",preload:"image"},mk_shortcode:function(t,e,i){var n=i||"",s="["+t,o=SWFPut_video_utility_obj_def.prototype.defprops;for(var a in e)void 0!==o[a]&&(s+=" "+a+'="'+e[a]+'"');return s+"]"+n+"[/"+t+"]"},atts_filter:function(t){var e=SWFPut_video_utility_obj_def.prototype.defprops,i={};for(var n in t)void 0!==e[n]&&(i[n]=t[n]);return i},date_now:function(){return Date.now?Date.now():(new Date).getTime()},unixtime:function(){return this.date_now()/1e3},loadtime_serial:0,get_new_putswf_shortcode:function(){var t=new Date,e='[putswf_video url="" iimage="" altvideo=""]',i="[/putswf_video]",n="Edit me please! "+t.toString()+", "+t.getTime()+"ms";return e+n+i},_wp:wp||!1,attachment_data_by_id:function(t,e){var i=t,n={status:0,response:null};this._wp&&this._wp.ajax.send("get-attachment",{data:{id:i}}).done(function(i){n.status=i?!0:null,n.response=i,e&&"function"==typeof e&&e(t,n)}).fail(function(i){n.status=!1,n.response=i,e&&"function"==typeof e&&e(t,n)})},attachments:{},get_attachment_by_id:function(t,e,i){if(void 0===this.attachments.id){if(void 0!==e&&e)return this.attachments.id=e,e;var n=this.attachments,s=i||!1;return this.attachment_data_by_id(t,function(t,e){e.status===!0?n[t]=e.response:n[t]=!1,"function"==typeof s&&s(t,e,n)}),null}return void 0!==e&&e&&(this.attachments.id=e),this.attachments.id}};var SWFPut_video_utility_obj=new SWFPut_video_utility_obj_def(wp||!1);if(SWFPut_video_utility_obj._bbone_mvc_opt===!0&&void 0!==wp&&void 0!==wp.mce&&void 0!==wp.mce.views&&void 0!==wp.mce.views.register&&"function"==typeof wp.mce.views.register){var SWFPut_add_button_func=function(t){var e,i=100,n=(t.id,SWFPut_video_utility_obj.get_new_putswf_shortcode()),s=SWFPut_putswf_video_inst.get_mce_dat(),o=window.encodeURIComponent(n),a=s.ed,r=!1;return a?(a.selection.setContent(n+"&nbsp;",{format:"text"}),e=setInterval(function(){var t,n=!1,s=a.$;if(r===!1){var d=s(".wpview-wrap");d.each(function(e){var i;return e=d[e],i=e.getAttribute("data-wpview-text"),i&&i.indexOf(o)>=0?(t=e,r=s(e),!1):void 0})}if(r!==!1){var c=r.find("iframe");c&&(a.selection.select(t,!0),a.selection.scrollIntoView(t),r.trigger("click"),n=!0)}(--i<=0||n)&&clearInterval(e)},1500),!1):(alert("Failed to get visual editor"),!1)},SWFPut_get_attachment_by_id=function(t,e,i){return SWFPut_video_utility_obj?SWFPut_video_utility_obj.get_attachment_by_id(t,e,i||!1):!1},SWFPut_cache_shortcode_ids=function(t,e){var i=[t.get("url"),t.get("altvideo"),t.get("iimage")],n=e&&"function"==typeof e?e:!1;_.each(i,function(t){void 0!=t&&_.each(t.split("|"),function(t){var i=t.match(/^[ \t]*([0-9]+)[ \t]*$/);if(i&&i[1]){var s=SWFPut_get_attachment_by_id(i[1],!1,n);if(null!==s&&n!==!1){var o=SWFPut_video_utility_obj.attachments;e(i[1],o[i[1]],o)}}})})},SWFPut_get_iframe_document=function(t,e,i,n){return t=t||"",e=e||"",i=i||"",n=n||"",'<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+t+e+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}.fix-alignleft {display: block;min-height: 32px;margin-top: 0;margin-bottom: 0;margin-left: 0px;margin-right: auto; }.fix-alignright {display: block;min-height: 32px;margin-top: 0;margin-bottom: 0;margin-right: 0px;margin-left: auto; }.fix-aligncenter {clear: both;display: block;margin: 0 auto; }.alignright .caption {padding-bottom: 0;margin-bottom: 0.1rem; }.alignleft .caption {padding-bottom: 0;margin-bottom: 0.1rem; }.aligncenter .caption {padding-bottom: 0;margin-bottom: 0.1rem; }</style></head><script type="text/javascript">var evhh5v_sizer_maxheight_off = true;</script><body id="wpview-iframe-sandbox" class="'+i+'">'+n+'</body><script type="text/javascript">( function() {["alignright", "aligncenter", "alignleft"].forEach( function( c, ix, ar ) {var nc = "fix-" + c, mxi = 100,cur = document.getElementsByClassName( c ) || [];for ( var i = 0; i < cur.length; i++ ) {var e = cur[i],mx = 0 + mxi,iv = setInterval( function() {var h = e.height || e.offsetHeight;if ( h && h > 0 ) {var cl = e.getAttribute( "class" );cl = cl.replace( c, nc );e.setAttribute( "class", cl );h += 2; e.setAttribute( "height", h );setTimeout( function() {h -= 2; e.setAttribute( "height", h );}, 250 );clearInterval( iv );} else {if ( --mx < 1 ) {clearInterval( iv );}}}, 50 );}} );}() );</script></html>'};!function(){var t=document.getElementById("evhvid-putvid-input-0");void 0!=t&&(t.onclick="return false;",t.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),t.blur(),SWFPut_add_button_func(t)},!1))}(),function(t,e,i,n){var s=t.media,o=SWFPut_video_utility_obj.defprops,a="undefined"==typeof _wpMediaViewsL10n?{}:_wpMediaViewsL10n,r=t.mce,d=r.av&&r.av.View?r.av.View:!1,c=!1;if(d===!1){c=!0;var l={state:[],setIframes:function(t,n,s,o){var a=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,r=this;this.getNodes(function(o,d,c){var l=o.dom,u="",h=o.getBody().className||"",p=o.getDoc().getElementsByTagName("head")[0];tinymce.each(l.$('link[rel="stylesheet"]',p),function(t){t.href&&-1===t.href.indexOf("skins/lightgray/content.min.css")&&-1===t.href.indexOf("skins/wordpress/wp-content.css")&&(u+=l.getOuterHTML(t))}),setTimeout(function(){function p(){var t,i;m.contentWindow&&(t=e(m),i=e(v.body).height(),t.height()!==i&&(t.height(i),o.nodeChanged()))}function f(){v.body.className=o.getBody().className}var m,v,_,w;if(c.innerHTML="",m=l.add(c,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"}}),l.add(c,"div",{"class":"wpview-overlay"}),v=m.contentWindow.document,v.open(),v.write(SWFPut_get_iframe_document(t,u,h,n)),v.close(),e(m.contentWindow).on("load",p),a){var g=v;_=new a(i.debounce(p,100)),_.observe(g,{attributes:!0,childList:!0,subtree:!0}),e(d).one("wp-mce-view-unbind",function(){_.disconnect()})}else for(w=1;6>w;w++)setTimeout(p,700*w);o.on("wp-body-class-change",f),e(d).one("wp-mce-view-unbind",function(){o.off("wp-body-class-change",f)}),s&&s.call(r,o,d,c)},50)},o)},marker_comp_prepare:function(t){var e,i=/[ \t]*data-mce[^=]*="[^"]*"/g,n=/[ \t]{2,}/g;return(e=t.substr(0).replace(i,""))&&(e=e.replace(n," ")),e||t},replaceMarkers:function(){this.getMarkers(function(t,i){var n=l.marker_comp_prepare(e(i).html()),s=l.marker_comp_prepare(this.text);return n!==s?void t.dom.setAttrib(i,"data-wpview-marker",null):void t.dom.replace(t.dom.createFragment('<div class="wpview-wrap" data-wpview-text="'+this.encodedText+'" data-wpview-type="'+this.type+'"><p class="wpview-selection-before">\xa0</p><div class="wpview-body" contenteditable="false"><div class="wpview-content wpview-type-'+this.type+'"></div></div><p class="wpview-selection-after">\xa0</p></div>'),i)})},match:function(e){var i=/\[(\[?)(putswf_video)(?![\w-])([^\]\/]*(?:\/(?!\])[^\]\/]*)*?)(?:(\/)\]|\](?:([^\[]*(?:\[(?!\/\2\])[^\[]*)*)(\[\/\2\]))?)(\]?)/g,n=i.exec(e);if(n){var s,o;return s=' capencoded="'+encodeURIComponent(n[5])+'"',o=n[3].indexOf(" capencoded="),o=0>o?n[3]+s:n[3].replace(/ capencoded="[^"]*"/g,s),{index:n.index,content:n[0],options:{shortcode:new t.shortcode({tag:n[2],attrs:o,type:n[6]?"closed":"single",content:n[5]})}}}},edit:function(e,n){var s=t.media[this.type],o=s.edit(e);this.pausePlayers&&this.pausePlayers(),i.each(this.state,function(t){o.state(t).on("update",function(t){var e=s.shortcode(t).string();n(e)})}),o.on("close",function(){o.detach()}),o.open()}},u=i.extend({},l,{action:"parse_putswf_video_shortcode",initialize:function(){var t=this;this.fetch(),this.getEditors(function(e){e.on("wpview-selected",function(){t.pausePlayers()})})},fetch:function(){var i=this,n=SWFPut_video_utility_obj.atts_filter(this.shortcode.attrs.named),s=SWFPut_video_utility_obj.mk_shortcode(this.shortcode.tag,n,this.shortcode.content);this.shortcode.string();t.ajax.send(this.action,{data:{post_ID:e("#post_ID").val()||0,type:this.shortcode.tag,shortcode:s}}).done(function(t){i.render(t)}).fail(function(t){i.url?i.removeMarkers():i.setError(t.message||t.statusText,"admin-media")})},stopPlayers:function(t){var i=t;this.getNodes(function(n,s,o){var a,r,d=e("iframe.wpview-sandbox",o).get(0);if(d&&(r=d.contentWindow)&&r.evhh5v_sizer_instances){try{for(a in r.evhh5v_sizer_instances){var c=r.evhh5v_sizer_instances[a],l=c.va_o||!1,u=c.o||!1,h="pause"===t?"pause":"stop";l&&"function"==typeof l[h]&&l[h](),u&&"function"==typeof u[h]&&u[h]()}}catch(p){p.message}"remove"===i&&(d.contentWindow=null,d=null)}})},pausePlayers:function(){this.stopPlayers&&this.stopPlayers("pause")}});r.views.register("putswf_video",i.extend({},u,{state:["putswf_video-details"]}))}else{var h=r.putswfMixin={View:i.extend({},d,{overlay:!0,action:"parse_putswf_video_shortcode",initialize:function(t){var n=this;t&&t.shortcode&&(console.log("VIEW OPTIONS SHORTCODE: "+t.shortcode),this.shortcode=t.shortcode),this.cache_shortcode_ids(this.shortcode),i.bindAll(this,"setIframes","setNodes","fetch","stopPlayers"),e(this).on("ready",this.setNodes),e(document).on("media:edit",this.stopPlayers),this.fetch(),this.getEditors(function(t){t.on("hide",n.stopPlayers)})},cache_shortcode_ids:SWFPut_cache_shortcode_ids,setIframes:function(n,s){var o,a=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver||!1,r=!0,d=180;n||-1!==s.indexOf("<script")?this.getNodes(function(c,l,u){var h,p,f,m,v=c.dom,_="",w=c.getBody().className||"";u.innerHTML="",n=n||"",r&&(t.mce.views.sandboxStyles?_=t.mce.views.sandboxStyles:(tinymce.each(v.$('link[rel="stylesheet"]',c.getDoc().head),function(t){t.href&&-1===t.href.indexOf("skins/lightgray/content.min.css")&&-1===t.href.indexOf("skins/wordpress/wp-content.css")&&(_+=v.getOuterHTML(t)+"\n")}),t.mce.views.sandboxStyles=_)),setTimeout(function(){o=setInterval(function(){return--d<=0?void clearInterval(o):(h=v.add(u,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"}})||!1,void(h&&(clearInterval(o),d*=4,o=setInterval(function(){if(--d<=0)return void clearInterval(o);if(p=h.contentWindow?h.contentWindow.document||!1:!1){p.open(),p.write(SWFPut_get_iframe_document(n,_,w,s)),p.close(),m=function(){var t;h.contentWindow&&(t=e(p.body).height(),e(h).height(t))};try{if(!a)throw ReferenceError("MutationObserver not supported");var t=p;new a(i.debounce(function(){m()},100)).observe(t,{attributes:!0,childList:!0,subtree:!0})}catch(l){for(l.message.length>0&&console.log("Exception: "+l.message),f=1;36>f;f++)setTimeout(m,1e3)}r&&c.on("wp-body-class-change",function(){p.body.className=c.getBody().className}),clearInterval(o)}},250))))},1e3)},100)}):this.setContent(s)},setNodes:function(){this.parsed?this.setIframes(this.parsed.head,this.parsed.body):this.fail()},fetch:function(){var i=this,n=SWFPut_video_utility_obj.atts_filter(this.shortcode.attrs.named),s=SWFPut_video_utility_obj.mk_shortcode(this.shortcode.tag,n,this.shortcode.content);this.shortcode.string();t.ajax.send(this.action,{data:{post_ID:e("#post_ID").val()||0,type:this.shortcode.tag,shortcode:s}}).done(function(t){t?(i.parsed=t,i.setIframes(t.head,t.body)):i.fail(!0)}).fail(function(t){i.fail(t||!0)})},fail:function(t){if(!this.error){if(!t)return;this.error=t}this.error.message?"not-embeddable"===this.error.type&&"embed"===this.type||"not-ssl"===this.error.type||"no-items"===this.error.type?this.setError(this.error.message,"admin-media"):this.setContent("<p>"+this.original+"</p>","replace"):this.error.statusText?this.setError(this.error.statusText,"admin-media"):this.original&&this.setContent("<p>"+this.original+"</p>","replace")},stopPlayers:function(t){var i=t;this.getNodes(function(n,s,o){var a,r,d=e("iframe.wpview-sandbox",o).get(0);if(d&&(r=d.contentWindow)&&r.evhh5v_sizer_instances){try{for(a in r.evhh5v_sizer_instances){var c=r.evhh5v_sizer_instances[a],l=c.va_o||!1,u=c.o||!1,h="pause"===t?"pause":"stop";l&&"function"==typeof l[h]&&l[h](),u&&"function"==typeof u[h]&&u[h]()}}catch(p){p.message}"remove"===i&&(d.contentWindow=null,d=null)}})},pausePlayers:function(){this.stopPlayers&&this.stopPlayers("pause")},unbind:function(){this.stopPlayers&&this.stopPlayers("remove")}})};r.views.register("putswf_video",i.extend({},h,{state:"putswf_video-details",toView:function(e){console.log("VIEW toView, content "+e);var i=t.shortcode.next(this.type,e);if(i)return{index:i.index,content:i.content,options:{shortcode:i.shortcode}}},edit:function(n){var s,o,a,r=t.media[this.type],d=this;e(document).trigger("media:edit"),console.log("VIEW-sub EDIT, type "+r),o=window.decodeURIComponent(e(n).attr("data-wpview-text")),s=r.edit(o),s.on("close",function(){s.detach()}),a=function(i){var o=t.media[d.type].shortcode(i).string();e(n).attr("data-wpview-text",window.encodeURIComponent(o)),t.mce.views.refreshView(d,o),s.detach()},i.isArray(d.state)?i.each(d.state,function(t){s.state(t).on("update",a)}):s.state(d.state).on("update",a),s.open()}}))}s.model.putswf_postMedia=n.Model.extend({SWFPut_cltag:"media.model.putswf_postMedia",initialize:function(t){if(this.attachment=this.initial_attrs=!1,void 0!==t&&void 0!==t.shortcode){var e=this,i=t.shortcode,n=/^[ \t]*([^ \t]*(.*[^ \t])?)[ \t]*$/;if(this.initial_attrs=t,this.poster="",this.flv="",this.html5s=[],i.iimage){var s=n.exec(i.iimage);this.poster=s&&s[1]?s[1]:i.iimage}if(i.url){var s=n.exec(i.url);this.flv=s&&s[1]?s[1]:i.url}if(i.altvideo)for(var o=i.altvideo,a=o.split("|"),r=0;r<a.length;r++){var s=n.exec(a[r]);s&&s[1]&&this.html5s.push(s[1])}SWFPut_cache_shortcode_ids(i,function(t,i,n){var s=""+t;if(e.initial_attrs.id_cache=n,void 0===e.initial_attrs.id_array&&(e.initial_attrs.id_array=[]),e.initial_attrs.id_array.push(t),e.poster===s)e.poster=n[t];else if(e.flv===s)e.flv=n[t];else if(null!==e.html5s)for(var o=0;o<e.html5s.length;o++)e.html5s[o]===s&&(e.html5s[o]=n[t])})}},poster:null,flv:null,html5s:null,setSource:function(e){this.attachment=e,this.extension=e.get("filename").split(".").pop(),this.get("src")&&this.extension===this.get("src").split(".").pop()&&this.unset("src"),i.contains(t.media.view.settings.embedExts,this.extension)?this.set(this.extension,this.attachment.get("url")):this.unset(this.extension);try{var n=e.get("putswf_attach_all");n&&n.toArray().length<1&&delete this.attachment.putswf_attach_all}catch(s){}},changeAttachment:function(e){var n=this;this.setSource(e),this.unset("src"),i.each(i.without(t.media.view.settings.embedExts,this.extension),function(t){n.unset(t)})},cleanup_media:function(){for(var t=[],e=!1,i=!1,n=!1,s=0;s<this.html5s.length;s++){var o=this.html5s[s];if("object"==typeof o){var a=o.subtype?o.subtype.split("-").pop():o.filename?o.filename.split(".").pop():!1;switch(a){case"mp4":case"m4v":case"mv4":e=o;break;case"ogg":case"ogv":case"vorbis":i=o;break;case"webm":case"wbm":case"vp8":case"vp9":n=o}}else t.push(o)}e&&t.push(e),i&&t.push(i),n&&t.push(n),this.html5s=t},get_poster:function(t){return t=t||!1,t&&null!==this.poster?"object"==typeof this.poster?this.poster.url:this.poster:null!==this.poster?"object"==typeof this.poster?""+this.poster.id:this.poster:""},get_flv:function(t){return t=t||!1,t&&null!==this.flv?"object"==typeof this.flv?this.flv.url:this.flv:null!==this.flv?"object"==typeof this.flv?""+this.flv.id:this.flv:""},get_html5s:function(t){var e="";if(t=t||!1,null===this.html5s)return e;for(var i=0;i<this.html5s.length;i++){var n=this.html5s[i],s="";""!==e&&(s+=" | "),s+="object"==typeof n?t?n.url:""+n.id:n,e+=s}return e},putswf_postex:function(){}}),s.view.MediaFrame.Putswf_mediaDetails=s.view.MediaFrame.Select.extend({defaults:{id:"putswf_media",url:"",menu:"media-details",content:"media-details",toolbar:"media-details",type:"link",priority:121},SWFPut_cltag:"media.view.MediaFrame.Putswf_mediaDetails",initialize:function(t){this.DetailsView=t.DetailsView,this.cancelText=t.cancelText,this.addText=t.addText,this.media=new s.model.putswf_postMedia(t.metadata),this.options.selection=new s.model.Selection(this.media.attachment,{multiple:!0}),s.view.MediaFrame.Select.prototype.initialize.apply(this,arguments)},bindHandlers:function(){var t=this.defaults.menu;s.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("menu:create:"+t,this.createMenu,this),this.on("content:render:"+t,this.renderDetailsContent,this),this.on("menu:render:"+t,this.renderMenu,this),this.on("toolbar:render:"+t,this.renderDetailsToolbar,this)},renderDetailsContent:function(){var t=this.state().media.attachment,e=new this.DetailsView({controller:this,model:this.state().media,attachment:t}).render();this.content.set(e)},renderMenu:function(t){var e=this.lastState(),i=e&&e.id,n=this;t.set({cancel:{text:this.cancelText,priority:20,click:function(){i?n.setState(i):n.close()}},separateCancel:new s.View({className:"separator",priority:40})})},setPrimaryButton:function(t,e){this.toolbar.set(new s.view.Toolbar({controller:this,items:{button:{style:"primary",text:t,priority:80,click:function(){var t=this.controller;e.call(this,t,t.state()),t.setState(t.options.state),t.reset()}}}}))},renderDetailsToolbar:function(){this.setPrimaryButton(a.update,function(t,e){t.close(),e.trigger("update",t.media.toJSON())})},renderReplaceToolbar:function(){this.setPrimaryButton(a.replace,function(t,e){var i=e.get("selection").single();t.media.changeAttachment(i),e.trigger("replace",t.media.toJSON())})},renderAddSourceToolbar:function(){this.setPrimaryButton(this.addText,function(t,e){var i=e.get("selection").single();t.media.setSource(i),e.trigger("add-source",t.media.toJSON())})}}),s.view.SWFPutDetails=s.view.Settings.AttachmentDisplay.extend({SWFPut_cltag:"media.view.SWFPutDetails",initialize:function(){i.bindAll(this,"success"),this.players=[],this.listenTo(this.controller,"close",s.putswf_mixin.unsetPlayers),this.on("ready",this.setPlayer),this.on("media:setting:remove",s.putswf_mixin.unsetPlayers,this),this.on("media:setting:remove",this.render),this.on("media:setting:remove",this.setPlayer),this.events=i.extend(this.events,{"click .remove-setting":"removeSetting","click .add-media-source":"addSource"}),s.view.Settings.AttachmentDisplay.prototype.initialize.apply(this,arguments)},prepare:function(){var t=this.model;return i.defaults({model:t},this.options)},removeSetting:function(t){var i,n=e(t.currentTarget).parent();i=n.find("input").data("setting"),i&&(this.model.unset(i),this.trigger("media:setting:remove",this)),n.remove()},setTracks:function(){},addSource:function(t){this.controller.lastMime=e(t.currentTarget).data("mime"),this.controller.setState("add-"+this.controller.defaults.id+"-source")},setPlayer:function(){},setMedia:function(){return this},success:function(){},render:function(){var t=this;return s.view.Settings.AttachmentDisplay.prototype.render.apply(this,arguments),setTimeout(function(){t.resetFocus()},10),this.settings=i.defaults({success:this.success},o),this.setMedia()},resetFocus:function(){this.$(".putswf_video-details-iframe").scrollTop(0)}},{instances:0,prepareSrc:function(t){var n=s.view.SWFPutDetails.instances++;return i.each(e(t).find("source"),function(t){t.src=[t.src,t.src.indexOf("?")>-1?"&":"?","_=",n].join("")}),t}}),s.view.Putswf_videoDetails=s.view.SWFPutDetails.extend({className:"putswf_video-mediaframe-details",template:s.template("putswf_video-details"),SWFPut_cltag:"media.view.Putswf_videoDetails",initialize:function(){i.bindAll(this,"success"),this.players=[],this.listenTo(this.controller,"close",t.media.putswf_mixin.unsetPlayers),this.on("ready",this.setPlayer),this.on("media:setting:remove",t.media.putswf_mixin.unsetPlayers,this),this.on("media:setting:remove",this.render),this.on("media:setting:remove",this.setPlayer),this.events=i.extend(this.events,{"click .add-media-source":"addSource"}),this.init_data=arguments&&arguments[0]?arguments[0]:!1,s.view.SWFPutDetails.prototype.initialize.apply(this,arguments)},setMedia:function(){var t=this.$(".evhh5v_vidobjdiv"),e=this.$(".wp-caption"),i=t||e,n=i.find("video")||i.find("canvas")||i.find("object");return n?(i.show(),this.media=s.view.SWFPutDetails.prepareSrc(i.get(0))):(i.hide(),this.media=!1),this}}),s.controller.Putswf_videoDetails=s.controller.State.extend({defaults:{id:"putswf_video-details",toolbar:"putswf_video-details",title:"SWFPut Video Details",content:"putswf_video-details",menu:"putswf_video-details",router:!1,priority:60},SWFPut_cltag:"media.controller.Putswf_videoDetails",initialize:function(t){this.media=t.media,s.controller.State.prototype.initialize.apply(this,arguments)},setSource:function(t){this.attachment=t,this.extension=t.get("filename").split(".").pop()}}),s.view.MediaFrame.Putswf_videoDetails=s.view.MediaFrame.Putswf_mediaDetails.extend({defaults:{id:"putswf_video",url:"",menu:"putswf_video-details",content:"putswf_video-details",toolbar:"putswf_video-details",type:"link",title:"SWFPut Video -- Media",priority:120},SWFPut_cltag:"media.view.MediaFrame.Putswf_videoDetails",initialize:function(t){this.media=t.media,t.DetailsView=s.view.Putswf_videoDetails,t.cancelText="Cancel Edit",t.addText="Add Video",s.view.MediaFrame.Putswf_mediaDetails.prototype.initialize.call(this,t)},bindHandlers:function(){s.view.MediaFrame.Putswf_mediaDetails.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:render:replace-putswf_video",this.renderReplaceToolbar,this),this.on("toolbar:render:add-putswf_video-source",this.renderAddSourceToolbar,this),this.on("toolbar:render:putswf_poster-image",this.renderSelectPosterImageToolbar,this)},createStates:function(){this.states.add([new s.controller.Putswf_videoDetails({media:this.media}),new s.controller.MediaLibrary({type:"video",id:"replace-putswf_video",title:"Replace Media",toolbar:"replace-putswf_video",media:this.media,menu:"putswf_video-details"}),new s.controller.MediaLibrary({type:"video",id:"add-putswf_video-source",title:"Add Media",toolbar:"add-putswf_video-source",media:this.media,multiple:!0,menu:"putswf_video-details"}),new s.controller.MediaLibrary({type:"image",id:"select-poster-image",title:a.SelectPosterImageTitle?a.SelectPosterImageTitle:"Set Initial (poster) Image",toolbar:"putswf_poster-image",media:this.media,menu:"putswf_video-details"})])},renderSelectPosterImageToolbar:function(){this.setPrimaryButton("Select Poster Image",function(t,e){var i=e.get("selection").single();i.attributes.putswf_action="poster",t.media.changeAttachment(i),e.trigger("replace",t.media.toJSON())})},renderReplaceToolbar:function(){this.setPrimaryButton("Replace Video",function(t,e){var i=e.get("selection").single();i.attributes.putswf_action="replace_video",t.media.changeAttachment(i),e.trigger("replace",t.media.toJSON())})},renderAddSourceToolbar:function(){this.setPrimaryButton(this.addText,function(t,e){var i=e.get("selection").single(),n=e.get("selection")||!1;i.attributes.putswf_action="add_video",n&&n.multiple&&(i.attributes.putswf_attach_all=n),t.media.setSource(i),e.trigger("add-source",t.media.toJSON())})}}),t.media.putswf_mixin={putswfSettings:o,SWFPut_cltag:"wp.media.putswf_mixin",removeAllPlayers:function(){},removePlayer:function(){},unsetPlayers:function(){}},t.media.putswf_video={defaults:o,SWFPut_cltag:"wp.media.putswf_video",_mk_shortcode:SWFPut_video_utility_obj.mk_shortcode,_atts_filter:SWFPut_video_utility_obj.atts_filter,edit:function(e){var n,o,a,r=t.shortcode.next("putswf_video",e).shortcode;s.view.MediaFrame;return o=r.attrs.named,o.content=r.content,o.shortcode=r,a={frame:"putswf_video",state:"putswf_video-details",metadata:i.defaults(o,this.defaults)},n=new s.view.MediaFrame.Putswf_videoDetails(a),s.frame=n,n},shortcode:function(e){var i,n,s;return n=e.shortcode.tag,i=e.content,s=t.media.putswf_video._atts_filter(e),new t.shortcode({tag:n,attrs:s,content:i})}}}(wp,jQuery,_,Backbone)}else tinymce.PluginManager.add("swfput_mceplugin",function(t,e){var i=tinymce.html.Node,n=t,s=e,o=s.split("/"),a=SWFPut_video_utility_obj.fpo;o[o.length-1]="mce_ifm.php",o=o.join("/");var r=function(t,e){return e?t.toLowerCase():t.toUpperCase()},d=function(t){return r(t,!0)},c=function(t){return d(t.nodeName)},l=function(t,e){return c(t)===d(e)},u=SWFPut_video_utility_obj.defprops;n.on("init",function(){}),n.on("mousedown",function(t){var e;l(t.target,"iframe")&&(e=n.dom.getParent(t.target,"div.evhTemp"))&&(tinymce.isGecko?n.selection.select(e):tinymce.isWebKit&&n.dom.events.prevent(t))}),n.on("keydown",function(t){var e,i,s=n.selection.getNode();if(s.className.indexOf("evh-pseudo")<0)return!0;if(e=n.dom.getParent(s,"div.evhTemp"),!e)return i="tinymce, SWFPut plugin: failed dom.getParent()",console.log(i),!1;var o=tinymce.VK||tinymce.util.VK;if(t.keyCode==o.ENTER)return n.dom.events.cancel(t),i=n.dom.create("p",null,"\ufeff"),n.dom.insertAfter(i,e),n.selection.setCursorLocation(i,0),!0;if(!l(s,"dd")){var a=[o.LEFT,o.UP,o.RIGHT,o.DOWN];return a.indexOf(t.keyCode)>=0?!0:(n.dom.events.cancel(t),!1)}}),n.on("preInit",function(){n.schema.addValidElements("evhfrm[*]"),n.parser.addNodeFilter("evhfrm",function(t){for(var e=0;e<t.length;e++)f(t[e])}),n.serializer.addNodeFilter("iframe",function(t,e){for(var i=0;i<t.length;i++){var n=t[i].attr("class");n&&n.indexOf("evh-pseudo")>=0&&m(t[i],e)}})}),n.on("BeforeSetContent",function(t){t.content=n.SWFPut_Set_code(t.content),n.nodeChanged()}),n.on("PostProcess",function(t){t.get&&(t.content=n.SWFPut_Get_code(t.content))}),n.on("BeforeExecCommand",function(t){var e=t.command;if("mceInsertContent"==e){var i,s,o=n.selection.getNode();if(o.className.indexOf("evh-pseudo")<0)return;if(l(o,"dd"))return;i=n.dom.getParent(o,"div.evhTemp"),i&&(s=n.dom.create("p",null,"\ufeff"),n.dom.insertAfter(s,i),n.selection.setCursorLocation(s,0),n.nodeChanged())}}),n.on("Paste",function(t){var e=n.selection.getNode(),i=n.dom.getParent(e,"div.evhTemp");if(!i)return!0;var s=t.clipboardData||dom.doc.dataTransfer;if(!s)return!0;var o=tinymce.isIE?"Text":"text/plain",a=SWFPut_repl_nl(s.getData(o));return setTimeout(function(){n.execCommand("mceInsertContent",!1,a)},1),t.preventDefault(),tinymce.dom.Event.cancel(t)}),n.SWFPut_Set_code=function(t){return w(t)},n.SWFPut_Get_code=function(t){return g(t)};var h={},p=function(){var t;do t=""+parseInt(32768*Math.random()+16384);while(t in h);return h[t]={},t},f=function(t){if(!t)return t;var e,n,s,o,a,r=!1;e=t.attr("width"),n=t.attr("height"),s=t.attr("src"),a=t.attr("class")||"",o=t.attr("id")||"";var d=""!==o?o.split("-")[1]:!1;return d&&d in h&&h[d].node&&(r=h[d].node),r||(r=new i("iframe",1),r.attr({id:o,"class":a.indexOf("evh-pseudo")>=0?a:a+" evh-pseudo",frameborder:"0",width:e,height:n,src:s}),d&&d in h&&(h[d].node=r)),t.replace(r),t},m=function(t){if(!t)return t;var e,n,s,o,a,r=!1;if(o=t.attr("id")||"",a=t.attr("class")||"",!(a.indexOf("evh-pseudo")<0)){e=t.attr("width"),n=t.attr("height"),s=t.attr("src");var d=""!==o?o.split("-")[1]:!1;return d&&d in h&&h[d].pnode&&(r=h[d].pnode),r||(r=new i("evhfrm",1),r.attr({id:o,"class":a,width:e,height:n,src:s}),d&&d in h&&(h[d].pnode=r)),t.replace(r),t}},v=function(t,e){var i={},n="",s="",o="&amp;";for(var a in u){var r=u[a],d=" "+a+'="([^"]*)"';d=new RegExp(d);var c=t.match(d);switch(c&&""!=c[1]&&(r=c[1]),i[a]=r,a){case"cssurl":case"audio":case"iimgbg":case"quality":case"mtype":case"playpath":case"classid":case"codebase":continue;case"displayaspect":i.aspect=r,n+=s+"aspect="+encodeURIComponent(r),s=o}n+=s+a+"="+encodeURIComponent(r),s=o}return void 0!==swfput_mceplug_inf&&(n+=s+"a="+encodeURIComponent(swfput_mceplug_inf.a)+o+"i="+encodeURIComponent(swfput_mceplug_inf.i)+o+"u="+encodeURIComponent(swfput_mceplug_inf.u)),i.qs=n,i.caption=e||"",i},_=function(t,e,i,n){var s=e.qs,o=parseInt(e.width),r=parseInt(e.height),d=o+60,c=o+16,l=r+16,u="width: "+d+"px",h='width="'+c+'" height="'+l+'" sandbox="allow-same-origin allow-pointer-lock allow-scripts" ';n=e.caption,""==n&&(n=a.ent);var p=" align"+e.align,f="wp-caption evh-pseudo-dl "+p,m="wp-caption-dt evh-pseudo-dt",v="wp-caption-dd evh-pseudo-dd",_="";return _+='<dl id="dl-'+i+'" class="'+f+'" style="'+u+'">',_+='<dt id="dt-'+i+'" class="'+m+'" data-no-stripme="sigh">',_+='<evhfrm id="'+i+'" class="evh-pseudo" '+h+' src="',_+=t+"?"+s,_+='"></evhfrm>',_+='</dt><dd id="dd-'+i+'" class="'+v+'">',_+=n+"</dd></dl>",e.code=_,e},w=function(t){var e=o;return t.replace(/([\r\n]*)?(<p>)?(\[putswf_video([^\]]+)\]([\s\S]*?)\[\/putswf_video\])(<\/p>)?([\r\n]*)?/g,function(t,i,n,s,o,a,r,d){var c=s,l=o,u=a,f=p();h[f]={},h[f].sc=c,h[f].p1=n||"",h[f].p2=r||"",h[f].n1=i||"",h[f].n2=d||"";var m=v(l,u);m=_(e,m,"evh-"+f,u);var w=m.width,g=(m.height,parseInt(w)+60),y="evhTemp mceIE"+m.align+" align"+m.align,b=i||"";return b+=n||"",b+='<div id="evh-sc-'+f+'" class="'+y+'" style="width: '+g+'px">',b+=m.code,b+="</div>",b+=r||"",b+=d||""})},g=function(t){return t.replace(/<div ([^>]*class="evhTemp[^>]*)>((.*?)<\/div>)/g,function(t,e,i,n){var s=e.match(/id="evh-sc-([0-9]+)"/);if(!s||!s[1])return t;s=s[1];var o="",r="",d="",c="",l="";if(h[s]&&(o=h[s].sc||"",r=h[s].p1||"",d=h[s].p2||"",c=h[s].n1||"",l=h[s].n2||"",n)){n=n.replace(/([\r\n]|<br[^>]*>)*/,"");var u=/.*<dd[^>]*>(.*)<\/dd>.*/.exec(n);u&&(u=u[1])&&(a.is(u,0)&&(u=""),o=o.replace(/^(.*\]).*(\[\/[a-zA-Z0-9_-]+\])$/,function(t,e,i){return e+u+i}),h[s].sc=o)}return o&&""!==o?c+r+o+d+l:t})};return{_do_shcode:w,_get_shcode:g}});