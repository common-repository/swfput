/*
 *      editor_plugin3x.js
 *      
 *      Copyright 2014 Ed Hynan <edhynan@gmail.com>
 *      
 *      This program is free software; you can redistribute it and/or modify
 *      it under the terms of the GNU General Public License as published by
 *      the Free Software Foundation; specifically version 3 of the License.
 *      
 *      This program is distributed in the hope that it will be useful,
 *      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *      GNU General Public License for more details.
 *      
 *      You should have received a copy of the GNU General Public License
 *      along with this program; if not, write to the Free Software
 *      Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 *      MA 02110-1301, USA.
 */
function SWFPut_repl_nl(e){return e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n/g,"<br />")}var SWFPut_video_tmce_plugin_fpo_obj=function(){if(void 0===this._fpo&&void 0!==SWFPut_putswf_video_inst)this.fpo=SWFPut_putswf_video_inst.fpo;else if(void 0===this.fpo){SWFPut_video_tmce_plugin_fpo_obj.prototype._fpo={};var e=this._fpo;e.cmt="<!-- do not strip me -->",e.ent=e.cmt,e.enx=e.ent;var t=document.createElement("div");t.innerHTML=e.ent,e.enc=t.textContent||t.innerText||e.ent,e.rxs="(("+e.cmt+")|("+e.enx+")|("+e.enc+"))",e.rxx=".*"+e.rxs+".*",e.is=function(t,n){return t.match(RegExp(n?e.rxs:e.rxx))},this.fpo=this._fpo}};SWFPut_video_tmce_plugin_fpo_obj.prototype={};var SWFPut_video_tmce_plugin_fpo_inst=new SWFPut_video_tmce_plugin_fpo_obj;!function(){var e=tinymce.html.Node,t=(parseInt(tinymce.majorVersion),SWFPut_video_tmce_plugin_fpo_inst.fpo),n=function(e,t){return t?e.toLowerCase():e.toUpperCase()},i=function(e){return n(e,!0)},o=function(e){return i(e.nodeName)},a=function(e,t){return o(e)===i(t)};tinymce.create("tinymce.plugins.SWFPut",{url:"",urlfm:"",editor:{},defs:{url:"",cssurl:"",iimage:"",width:"240",height:"180",mobiwidth:"0",audio:"false",aspectautoadj:"false",displayaspect:"0",pixelaspect:"0",volume:"50",play:"false",hidebar:"true",disablebar:"false",iimgbg:"true",barheight:"36",quality:"high",allowfull:"true",allowxdom:"false",loop:"false",mtype:"application/x-shockwave-flash",playpath:"",altvideo:"",classid:"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000",codebase:"http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,115,0",align:"center",preload:"image"},init:function(e,t){var n=this;n.old;n.url=t;var i=t.split("/");i[i.length-1]="mce_ifm.php",n.urlfm=i.join("/"),n.editor=e,e.onPreInit.add(function(){e.schema.addValidElements("evhfrm[*]"),e.parser.addNodeFilter("evhfrm",function(e,t){for(var i=0;i<e.length;i++)n.from_pseudo(e[i],t)}),e.serializer.addNodeFilter("iframe",function(e,t){for(var i=0;i<e.length;i++){var o=e[i].attr("class");o&&o.indexOf("evh-pseudo")>=0&&n.to_pseudo(e[i],t)}})}),e.onInit.add(function(e){e.dom.events.add(e.getBody(),"mousedown",function(t){var n;a(t.target,"iframe")&&(n=e.dom.getParent(t.target,"div.evhTemp"))&&(tinymce.isGecko?e.selection.select(n):tinymce.isWebKit&&e.dom.events.prevent(t))}),e.dom.events.add(e.getBody(),"keydown",function(t){var n,i,o=e.selection.getNode();if(o.className.indexOf("evh-pseudo")<0)return!0;if(n=e.dom.getParent(o,"div.evhTemp"),!n)return i="tinymce, SWFPut plugin: failed dom.getParent()",console.log(i),!1;if(13==t.keyCode)return e.dom.events.cancel(t),i=e.dom.create("p",null,"\ufeff"),e.dom.insertAfter(i,n),void 0!=e.selection.setCursorLocation?e.selection.setCursorLocation(i,0):(i=i.firstChild||i,e.selection.select(i)),!0;if(a(o,"dd"))return!0;var r=[37,38,39,40];return r.indexOf(t.keyCode)>=0?!0:(e.dom.events.cancel(t),!1)})}),e.onBeforeSetContent.add(function(e,t){t.content=e.SWFPut_Set_code(t.content)}),e.onPostProcess.add(function(e,t){t.get&&(t.content=e.SWFPut_Get_code(t.content))}),e.onBeforeExecCommand.add(function(e,t){if("mceInsertContent"==t){var n,i,o=e.selection.getNode();if(o.className.indexOf("evh-pseudo")<0)return;if(a(o,"dd"))return;n=e.dom.getParent(o,"div.evhTemp"),n&&(i=e.dom.create("p",null,"\ufeff"),e.dom.insertAfter(i,n),void 0!=e.selection.setCursorLocation?e.selection.setCursorLocation(i,0):(i=i.firstChild||i,e.selection.select(i)),e.nodeChanged())}}),e.onPaste.add(function(e,t){var n=e.selection.getNode(),i=e.dom.getParent(n,"div.evhTemp");if(!i)return!0;var o=t.clipboardData||dom.doc.dataTransfer;if(!o)return!0;var a=tinymce.isIE?"Text":"text/plain",r=SWFPut_repl_nl(o.getData(a));return setTimeout(function(){e.execCommand("mceInsertContent",!1,r)},1),t.preventDefault(),tinymce.dom.Event.cancel(t)}),e.SWFPut_Set_code=function(e){return n._do_shcode(e)},e.SWFPut_Get_code=function(e){return n._get_shcode(e)}},sc_map:{},newkey:function(){var e;do e=""+parseInt(32768*Math.random()+16384);while(e in this.sc_map);return this.sc_map[e]={},e},from_pseudo:function(t){if(!t)return t;var n,i,o,a,r,s=this,c=!1;n=t.attr("width"),i=t.attr("height"),o=t.attr("src"),r=t.attr("class")||"",a=t.attr("id")||"";var d=""!==a?a.split("-")[1]:!1;return d&&d in s.sc_map&&s.sc_map[d].node&&(c=s.sc_map[d].node),c||(c=new e("iframe",1),c.attr({id:a,"class":r.indexOf("evh-pseudo")>=0?r:r+" evh-pseudo",frameborder:"0",width:n,height:i,src:o}),d&&d in s.sc_map&&(s.sc_map[d].node=c)),t.replace(c),t},to_pseudo:function(t){if(!t)return t;var n,i,o,a,r,s=this,c=!1;if(a=t.attr("id")||"",r=t.attr("class")||"",!(r.indexOf("evh-pseudo")<0)){n=t.attr("width"),i=t.attr("height"),o=t.attr("src");var d=""!==a?a.split("-")[1]:!1;return d&&d in s.sc_map&&s.sc_map[d].pnode&&(c=s.sc_map[d].pnode),c||(c=new e("evhfrm",1),c.attr({id:a,"class":r,width:n,height:i,src:o}),d&&d in s.sc_map&&(s.sc_map[d].pnode=c)),t.replace(c),t}},_sc_atts2qs:function(e,t){var n={},i=this,o="",a="",r="&amp;",s=i.defs;for(var c in s){var d=s[c],p=" "+c+'="([^"]*)"';p=new RegExp(p);var u=e.match(p);switch(u&&""!=u[1]&&(d=u[1]),n[c]=d,c){case"cssurl":case"audio":case"iimgbg":case"quality":case"mtype":case"playpath":case"classid":case"codebase":continue;case"displayaspect":n.aspect=d,o+=a+"aspect="+encodeURIComponent(d),a=r}o+=a+c+"="+encodeURIComponent(d),a=r}return void 0!==swfput_mceplug_inf&&(o+=a+"a="+encodeURIComponent(swfput_mceplug_inf.a)+r+"i="+encodeURIComponent(swfput_mceplug_inf.i)+r+"u="+encodeURIComponent(swfput_mceplug_inf.u)),n.qs=o,n.caption=t||"",n},_sc_atts2if:function(e,n,i,o){var a=n.qs,r=parseInt(n.width),s=parseInt(n.height),c=r+60,d=r+16,p=s+16,u="width: "+c+"px",l='width="'+d+'" height="'+p+'" sandbox="allow-same-origin allow-pointer-lock allow-scripts" ';o=n.caption,""==o&&(o=t.ent);var f=" align"+n.align,m="wp-caption evh-pseudo-dl "+f,_="wp-caption-dt evh-pseudo-dt",h="wp-caption-dd evh-pseudo-dd",v="";return v+='<dl id="dl-'+i+'" class="'+m+'" style="'+u+'">',v+='<dt id="dt-'+i+'" class="'+_+'" data-no-stripme="sigh">',v+='<evhfrm id="'+i+'" class="evh-pseudo" '+l+' src="',v+=e+"?"+a,v+='"></evhfrm>',v+='</dt><dd id="dd-'+i+'" class="'+h+'">',v+=o+"</dd></dl>",n.code=v,n},_do_shcode:function(e){var t=this;t.urlfm,t.defs;return e.replace(/([\r\n]*)?(<p>)?(\[putswf_video([^\]]+)\]([\s\S]*?)\[\/putswf_video\])(<\/p>)?([\r\n]*)?/g,function(e,n,i,o,a,r,s,c){var d=o,p=a,u=r,l=t.newkey();t.sc_map[l]={},t.sc_map[l].sc=d,t.sc_map[l].p1=i||"",t.sc_map[l].p2=s||"",t.sc_map[l].n1=n||"",t.sc_map[l].n2=c||"";var f=t._sc_atts2qs(p,u);f=t._sc_atts2if(t.urlfm,f,"evh-"+l,u);var m=f.width,_=(f.height,parseInt(m)+60),h="evhTemp mceIE"+f.align+" align"+f.align,v=n||"";return v+=i||"",v+='<div id="evh-sc-'+l+'" class="'+h+'" style="width: '+_+'px">',v+=f.code,v+="</div>",v+=s||"",v+=c||""})},_get_shcode:function(e){var n=this;return e.replace(/<div ([^>]*class="evhTemp[^>]*)>((.*?)<\/div>)/g,function(e,i,o,a){var r=i.match(/id="evh-sc-([0-9]+)"/);if(!r||!r[1])return e;r=r[1];var s="",c="",d="",p="",u="";if(n.sc_map[r]&&(s=n.sc_map[r].sc||"",c=n.sc_map[r].p1||"",d=n.sc_map[r].p2||"",p=n.sc_map[r].n1||"",u=n.sc_map[r].n2||"",a)){a=a.replace(/([\r\n]|<br[^>]*>)*/,"");var l=/.*<dd[^>]*>(.*)<\/dd>.*/.exec(a);l&&(l=l[1])&&(t.is(l,0)&&(l=""),s=s.replace(/^(.*\]).*(\[\/[a-zA-Z0-9_-]+\])$/,function(e,t,n){return t+l+n}),n.sc_map[r].sc=s)}return s&&""!==s?p+c+s+d+u:e})},createControl:function(){return null},getInfo:function(){return{longname:"SWFPut Video Player",author:"EdHynan@gmail.com",authorurl:"",infourl:"",version:"1.1"}}}),tinymce.PluginManager.add("swfput_mceplugin",tinymce.plugins.SWFPut)}();